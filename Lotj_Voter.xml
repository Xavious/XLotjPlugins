<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Thursday, March 16, 2017, 11:51 AM -->
<!-- MuClient version 4.94 -->

<!-- Plugin "Lotj_Voter" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Lotj_Voter"
   author="Xavious"
   id="03b5ecafcfde268119c55d3b"
   language="Lua"
   purpose="Vote for Lotj on TMC"
   save_state="y"
   date_written="2017-03-16 11:51:03"
   requires="4.94"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Aliases  -->

<aliases>
  <alias
   match="vote now"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	vote()
  </send>
  </alias>
  <alias
   match="vote help"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	showHelp()
  </send>
  </alias>
  <alias
   match="vote set username *"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	setUsername("%1")
  </send>
  </alias>
  <alias
   match="vote set password *"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	setPassword("%1")
  </send>
  </alias>
  <alias
   match="vote show password"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	showPassword()
  </send>
  </alias>
  <alias
   match="vote set time *"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	setTime("%1")
  </send>
  </alias>
  <alias
   match="vote set auto *"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	setAuto("%1")
  </send>
  </alias>
</aliases>

<!--  Script  -->


<script>
<![CDATA[
function showHelp()
	username = GetVariable("username")
	password = GetVariable("password")
	hour = GetVariable("hour")..":00"
	auto = GetVariable("auto")
	
	Note("____________________________")
	Note("       Lotj Voter       ")
	Note("----------------------------")
	Note("Username: "..username)
	Note("VoteTime: "..hour)
	Note("AutoVote: "..auto)
	Note("----------------------------")
	Note("         Commands           ")
	Note("----------------------------")
	Note("vote set username <username>")
	Note("vote set password <password>")
	Note("vote show password")
	Note("vote set time <0-23>")
	Note("vote set auto <on/off>")
	Note("vote help")
	Note("vote now")
	Note("----------------------------")
end

function setUsername(username)
	SetVariable("username", username)
	Note("Username set to: "..username)
end

function setPassword(password)
	SetVariable("password", password)
	Note("Password set.")
end

function showPassword()
	password = GetVariable("password")
	utils.msgbox ("Your password is: "..password, "Password", "ok", "!", 1)
end

function setTime(hour)
	hour = tonumber(hour)
	auto = GetVariable("auto")
	if string.lower(auto) == "on" then
		enable = 1
	else
		enable = 0
	end
	if type(hour) == "number" and hour >= 0 and hour <= 23 then
		hour = math.floor(hour)
		SetVariable("hour", hour)
		AddTimer("VoteTimer", hour, 0, 0, "vote()", timer_flag.Replace + timer_flag.ActiveWhenClosed + timer_flag.AtTime + enable)
		SetTimerOption("VoteTimer", "send_to", 12)
		Note("Vote time set to: "..hour..":00")
	else
		Note("Invalid time. Must be an hour bewteen 0 and 23")
	end
end

function setAuto(auto)
	if string.lower(auto) == "on" then
		SetVariable("auto", "on")
		EnableTimer("VoteTimer", true)
		ResetTimer("VoteTimer")
		Note("Auto voting enabled.")
	elseif string.lower(auto) == "off" then
		SetVariable("auto", "off")
		EnableTimer("VoteTimer", false)
		Note("Auto voting disabled.")
	else
		Note("Invalid option.")
	end
end

function vote()
	Note("Initiating voting sequence...")
	session = postLogin()
	if session then
		postVote(session)
	end
end

function postLogin()
	username = GetVariable("username")
	password = GetVariable("password")
	http = require "socket.http"
	require "tprint"
	url = "https://www.mudconnect.com/cgi-bin/login.cgi"
	reqbody = "mode=DO_LOGIN&uid="..username.."&password="..password
	Note("Attempting to login to TMC..")
	b, c, h, s = http.request(url,reqbody)
	--Parse the session ID and forum cookie from the set-cookie response header.
	if c == 200 then
		if string.match(b, "Welcome%sback%sto%sTMC,%slogging%syou%sin...") then
			Note("Login successful.")
			_, _, TMC_AUTH, TMC_LT = string.find(b, "%-:%-(%w+)%-:%-(%w+)';")
			session = "TMC_ID="..username.."; TMC_AUTH="..TMC_AUTH.."; TMC_LT="..TMC_LT
			return session
		elseif string.match(b, "Invalid%s+login%s+credentials") then
			Note("TMC: Invalid login credentials.")
		elseif string.match(b, "Password%s+is%s+incorrect") then
			Note("TMC: Password incorrect.")
		else
			Note("Unknown error while attempting to login.")
		end
	else
		Note("Unexpected HTTP code.")
	end

end

function postVote(session)
	require 'socket.http'
	local request_body = "mode=cast_vote&mud=Legends+of+the+Jedi"
	local response_body = { }
	Note("Attempting to place vote.")
	local b, c, h = socket.http.request
	{
	  url = "https://www.mudconnect.com/cgi-bin/vote.cgi?mode=cast_vote&mud=Legends+of+the+Jedi",
	  method = "GET",
	  headers = 
	  {
		["Host"] = "www.mudconnect.com",
		["User-Agent"] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:71.0) Gecko/20100101 Firefox/71.0",
		["Accept"] = "text/html, */*; q=0.01",
		["Connection"] = "keep-alive",
		["X-Requested-With"] = "XMLHttpRequest",
		["Referer"] = "https://www.mudconnect.com/cgi-bin/search.cgi?mode=mud_listing&mud=Legends+of+the+Jedi",
		["Cookie"] = session,
		["content-type"] = "text/html; charset=ISO-8859-1",
		["Content-Length"] = #request_body,
	  };
	  source = ltn12.source.string(request_body);
	  sink = ltn12.sink.table(response_body)
	}
	b = table.concat(response_body)
	if string.match(b, "Your%s+vote%s+was%s+cast") then
		Note("TMC: Your vote was cast for Legends of the Jedi. Please note that only 1 daily vote per mud will be counted for each TMC account.")
	else
		Note("Error: Unexpected response")
	end
end

function OnPluginInstall ()
	username = GetVariable("username")
	if username == nil then
		SetVariable("username", "Undefined")
	end
	password = GetVariable("password")
	if password == nil then
		SetVariable("password", "Undefined")
	end
	hour = GetVariable("hour")
	if hour == nil then
		SetVariable("hour", "0")
	else
		setTime(hour)
	end
	auto = GetVariable("auto")
	if auto == nil then
		SetVariable("auto", "off")
	else
		setAuto(auto)
	end
	showHelp()
end 

]]>
</script>


</muclient>
